@page
@using DevExtreme.AspNet.Mvc
@using SmachotMemories.DTOs
@using SmachotMemories.Models
@using SmachotMemories.Models.Enums
@model SmachotMemories.Pages.EventsModel
@{
}

<div style="margin-bottom: 15px;">
    @(Html.DevExtreme().ButtonGroup()
        .ID("statusButtonGroup")
        .SelectionMode(ButtonGroupSelectionMode.Single)
        .Items(items =>
        {
            items.Add().Text("Active");
            items.Add().Text("Future");
            items.Add().Text("Past");
        })
        .SelectedItemKeys(new[] { "Active" })
        .KeyExpr("text")
        .OnSelectionChanged("onStatusChanged")
    )
</div>

@(Html.DevExtreme().DataGrid<EventDto>()
    .ID("event")
    .ElementAttr(new { @class = "dx-card wide-card" })
    .DataSource(d => d.Mvc().Controller("Events")
                    .LoadAction("Load")
                    .LoadParams(new { eventStatus = new JS("function () { return eventStatus;} "), HallId = new JS("function () { return hallId;} ") })
                    .InsertAction("Insert")
                    .UpdateAction("Update")
                    .DeleteAction("Delete")
                    .Key("EventId"))
    .Editing(x => x
                 .AllowAdding(true)
                 .AllowDeleting(true)
                 .AllowUpdating(true)
                .Mode(GridEditMode.Popup)
                .Popup(p => p.Title("Event Info").ShowTitle(true).Width(700).Height(575)))
    .ShowBorders(false)
    .FilterRow(f => f.Visible(true))
    .RemoteOperations(true)
    .AllowColumnResizing(true)
    .StateStoring(s => s.Enabled(true).StorageKey("events1"))
    .FilterRow(filterRow => filterRow
    .Visible(true)
    .ApplyFilter(GridApplyFilterMode.Auto))
    .SearchPanel(searchPanel => searchPanel
    .Visible(true)
    .Placeholder("Search..."))
    .HeaderFilter(headerFilter => headerFilter.Visible(true))
    .Columns(columns =>
    {
        columns.AddFor(m => m.EventName);
        columns.AddFor(m => m.EventStartDate).DataType(GridColumnDataType.DateTime);
        columns.AddFor(m => m.EventEndDate).DataType(GridColumnDataType.DateTime);
        columns.AddFor(m => m.BackgroundImageUrl)
            .Caption("Background Image")
            .CellTemplate(@<text>
                           [% if (data.BackgroundImageUrl) { %]
                           <img src="/[%- data.BackgroundImageUrl %]" alt="Event Background" style="max-width: 100px; max-height: 100px;" />
                           [% } else { %]
                           <span>No Image</span>
                           [% } %]
                       </text>);
        columns.AddFor(m => m.EventTypeId)
            .Caption("Event Type")
            .Lookup(lookup => lookup
                .DataSource(d => d.Mvc().Controller("Events").LoadAction("GetEventTypes").Key("EventTypeId"))
                .ValueExpr("EventTypeId")
                .DisplayExpr("EventTypeName")
                .AllowClearing(true));
        columns.AddFor(m => m.CreatedAt).AllowEditing(false);
        columns.AddFor(m => m.OwnerUserId)
            .Caption("Owner User")
            .Lookup(lookup => lookup
                .DataSource(d => d.Mvc().Controller("Events").LoadAction("GetUsers").Key("Id"))
                .ValueExpr("Id")
                .DisplayExpr("Name"))
            .CellTemplate(@<text>
                           <a style="margin-left: 5px" href="/UserDetails?OwnerUserId=[%- data.OwnerUserId%]">
                               [%- data.OwnerUserName%]
                           </a>
                       </text>);
        columns.AddFor(m => m.HallId)
            .Caption("Hall")
            .Lookup(lookup => lookup
                .DataSource(d => d.Mvc().Controller("Events").LoadAction("GetHalls").Key("HallId"))
                .ValueExpr("HallId")
                .DisplayExpr("Name"))
            .CellTemplate(@<text>
                           <a style="margin-left: 5px" href="/HallDetails?HallId=[%- data.HallId%]">
                               [%- data.HallName%]
                           </a>
                       </text>);
        columns.AddFor(m => m.DownloadStatus)
            .Caption("Download Status")
            .AllowEditing(false)
              .FormItem(f => f.Visible(false))
            .Width(150)
            .CellTemplate(@<text>
                <div class="download-status-cell">
                    [% if (data.DownloadStatus === @((int)DownloadStatusEnum.FullyDownloaded)) { %]
                        <span class="download-badge fully-downloaded" title="Last downloaded: [%- data.LastDownloadedAt ? new Date(data.LastDownloadedAt).toLocaleString() : 'N/A' %]">
                            <i class="dx-icon-check"></i> Fully Downloaded
                        </span>
                    [% } else if (data.DownloadStatus === @((int)DownloadStatusEnum.PartiallyDownloaded)) { %]
                        <span class="download-badge partially-downloaded" title="Last downloaded: [%- data.LastDownloadedAt ? new Date(data.LastDownloadedAt).toLocaleString() : 'N/A' %]">
                            <i class="dx-icon-warning"></i> Partially Downloaded
                        </span>
                    [% } else { %]
                        <span class="download-badge not-downloaded">
                            <i class="dx-icon-close"></i> Not Downloaded
                        </span>
                    [% } %]
                </div>
            </text>);
        columns.Add()
            .Caption("Details")
              .FormItem(f => f.Visible(false))
            .AllowEditing(false)
            .AllowFiltering(false)
            .AllowSorting(false)
            .Width(100)
            .CellTemplate(@<text>
                <a href="/EventDetails?EventId=[%- data.EventId%]" class="event-details-link" title="View Event Details">
                    <i class="dx-icon-folder" style="font-size: 18px;"></i> View
                </a>
            </text>);
    })
    .Paging(p => p.PageSize(10))
    .Pager(p => p
        .ShowPageSizeSelector(true)
        .AllowedPageSizes(new[] { 5, 10, 20 })
        .ShowInfo(true))
    .Toolbar(toolbar =>
    {
        toolbar.Items(items =>
        {
            items.Add()
            .Name("searchPanel");
            items.Add()
       .Location(ToolbarItemLocation.After)
       .Widget(w =>
           w.Button()
               .Icon("add")
               .Text("Add New Row")
               .OnClick("onAddRow")
        );
            items.Add()
           .Location(ToolbarItemLocation.After)
               .Widget(w =>
                   w.Button()
                    .Icon("export")
                    .Text("Export")
                        .OnClick("onExporting")
                 );
        });

    })
)

<style>
    .download-status-cell {
        display: flex;
        align-items: center;
    }

    .download-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .download-badge.fully-downloaded {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .download-badge.partially-downloaded {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .download-badge.not-downloaded {
        background: #e5e7eb;
        color: #6b7280;
    }

    .download-badge i {
        font-size: 14px;
    }
</style>

<script>
    var eventStatus = @((int)EventStatus.Active);
    @* var focusEventId = @(ViewData["EventId"] ?? "null"); *@
    var focusEventId = @Model.EventId;
    var hallId = @Model.hallId;

    var statusMap = {
        "Active": @((int)EventStatus.Active),
        "Future": @((int)EventStatus.Future),
        "Past": @((int)EventStatus.Past)
    };

    function onStatusChanged(e) {
        if (e.addedItems.length > 0) {
            var selectedText = e.addedItems[0].text;
            eventStatus = statusMap[selectedText];
            var grid = $("#event").dxDataGrid("instance");
            grid.refresh();
        }
    }

    $(document).ready(function() {
        if (focusEventId) {
            // Get the event status to determine which tab to switch to
            $.get('/api/Events/GetEventStatus', { eventId: focusEventId })
                .done(function(response) {
                    var targetStatus = response.status;
                    var targetTab = Object.keys(statusMap).find(key => statusMap[key] === targetStatus);
                    
                    if (targetTab) {
                        eventStatus = targetStatus;
                        $("#statusButtonGroup").dxButtonGroup("instance").option("selectedItemKeys", [targetTab]);
                        
                        var grid = $("#event").dxDataGrid("instance");
                        grid.option("onContentReady", function() {
                            var rowIndex = grid.getRowIndexByKey(focusEventId);
                            if (rowIndex >= 0) {
                                grid.selectRows([focusEventId]);
                                grid.navigateToRow(focusEventId);
                            }
                        });
                        grid.refresh();
                    }
                });
        }
    });

    function onExporting() {
        var grid = DevExpress.ui.dxDataGrid.getInstance(document.getElementById('uiText'));
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('Main sheet');

        DevExpress.excelExporter.exportDataGrid({
            worksheet: worksheet,
            component: grid
        }).then(function () {
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'DataGrid.xlsx');
            });
        });
    }

    function onAddRow() {
        const dataGrid = $("#event").dxDataGrid("instance");
        dataGrid.addRow();
    }

</script>