@page
@using DevExtreme.AspNet.Mvc
@using SmachotMemories.DTOs
@model SmachotMemories.Pages.HallFeedbackModel
@{
    ViewData["Title"] = $"Hall Feedback - {Model.HallName}";
}

<div class="hall-feedback-container">
    <div class="page-header">
        <h1><i class="dx-icon-comment"></i> Hall Feedback</h1>
        <p class="subtitle">@Model.HallName</p>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-number">@Model.TotalFeedback</span>
            <span class="stat-label">Total Feedback</span>
        </div>
        @if (Model.TotalFeedback > 0)
        {
            <div class="stat-item">
                <span class="stat-number">@Model.WaiterFeedbackCount</span>
                <span class="stat-label">Waiter</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@Model.FoodFeedbackCount</span>
                <span class="stat-label">Food</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@Model.DesignFeedbackCount</span>
                <span class="stat-label">Design</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@Model.FreeFeedbackCount</span>
                <span class="stat-label">Free</span>
            </div>
        }
    </div>

    @(Html.DevExtreme().DataGrid<HallFeedbackDto>()
        .ID("hallFeedback")
        .ElementAttr(new { @class = "dx-card wide-card" })
        .DataSource(Model.Feedbacks)
        .ShowBorders(false)
        .FilterRow(f => f.Visible(true).ApplyFilter(GridApplyFilterMode.Auto))
        .SearchPanel(sp => sp.Visible(true).Placeholder("Search feedback..."))
        .HeaderFilter(hf => hf.Visible(true))
        .AllowColumnResizing(true)
        .ColumnAutoWidth(true)
        .Columns(columns =>
        {
            columns.Add()
                .DataField("HallFeedbackId")
                .Caption("ID")
                .Width(70);

            columns.Add()
                .DataField("CategoryName")
                .Caption("Category")
                .Width(120)
                .CellTemplate(@<text>
                    <span class="category-badge category-[%- data.CategoryName.toString().toLowerCase() %]">
                        [%- data.CategoryName %]
                    </span>
                </text>);

            columns.Add()
                .DataField("TableNumber")
                .Caption("Table #")
                .Width(80);

            columns.Add()
                .DataField("Content")
                .Caption("Feedback Content");

            columns.Add()
                .DataField("EventId")
                .Caption("Event")
                .Width(100)
                .CellTemplate(@<text>
                    <a href="/EventDetails?EventId=[%- data.EventId %]" class="event-link">
                        Event #[%- data.EventId %]
                    </a>
                </text>);

            columns.Add()
                .DataField("CreatedAt")
                .Caption("Date")
                .DataType(GridColumnDataType.DateTime)
                .Format("dd/MM/yyyy HH:mm")
                .Width(150)
                .SortOrder(SortOrder.Desc);
        })
        .Paging(p => p.PageSize(10))
        .Pager(p => p
            .ShowPageSizeSelector(true)
            .AllowedPageSizes(new[] { 5, 10, 20, 50 })
            .ShowInfo(true)
        )
        .Export(e => e.Enabled(true).AllowExportSelectedData(false))
        .Toolbar(toolbar =>
        {
            toolbar.Items(items =>
            {
                items.Add().Name("searchPanel");
                items.Add()
                    .Location(ToolbarItemLocation.After)
                    .Widget(w => w.Button()
                        .Icon("export")
                        .Text("Export")
                        .OnClick("onExporting"));
            });
        })
    )

    <div class="back-link">
        <a href="/Halls" class="btn-back">
            <i class="dx-icon-arrowleft"></i> Back to Halls
        </a>
    </div>
</div>

<style>
    .hall-feedback-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .page-header h1 {
        font-size: 2.2rem;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .subtitle {
        font-size: 1.1rem;
        color: #666;
        margin: 0;
    }

    .stats-bar {
        display: flex;
        justify-content: center;
        gap: 40px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        margin-bottom: 30px;
        color: white;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
    }

    .stat-number {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .category-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: capitalize;
    }

    .category-waiter {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .category-food {
        background-color: #fff3e0;
        color: #e65100;
    }

    .category-design {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }

    .category-free {
        background-color: #e8f5e9;
        color: #388e3c;
    }

    .event-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .event-link:hover {
        color: #764ba2;
    }

    .back-link {
        text-align: center;
        margin-top: 30px;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background-color: #f5f5f5;
        color: #333;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-back:hover {
        background-color: #e0e0e0;
        color: #333;
    }

    @@media (max-width: 768px) {
        .stats-bar {
            gap: 20px;
            padding: 16px;
        }

        .stat-number {
            font-size: 1.2rem;
        }

        .page-header h1 {
            font-size: 1.8rem;
        }
    }
</style>

<script>
    function onExporting() {
        var grid = $("#hallFeedback").dxDataGrid("instance");
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('Hall Feedback');

        DevExpress.excelExporter.exportDataGrid({
            worksheet: worksheet,
            component: grid
        }).then(function () {
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'HallFeedback.xlsx');
            });
        });
    }
</script>
