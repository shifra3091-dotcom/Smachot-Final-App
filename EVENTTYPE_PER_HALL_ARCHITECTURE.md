# ??? EventType Per Hall - ?????

## ?? ????? ????????

????? ??? **Many-to-Many** ????? ??? Halls ?-EventTypes, ????? ?? ???? ???? **EventType ????**.

## ?? ??????????? ?????

### ???? ?????? (Many-to-Many):
```
EventType (??????)
    ?? Wedding (????? ??? ???????)
    ?? BarMitzvah (????? ??? ???????)
    ?? Brit (????? ??? ???????)

Hall_EventTypes (Junction Table)
    Hall 1 ? EventType 1 (Wedding)
    Hall 1 ? EventType 2 (BarMitzvah)
    Hall 2 ? EventType 3 (Brit)
```

### ???? ?????? (One-to-Many):
```
Hall 1
    ?? EventType: "Wedding" (?????? ????? 1)
    ?   ?? ReadyAlbum: "Ceremony"
    ?   ?? ReadyAlbum: "Reception"
    ?? EventType: "BarMitzvah" (?????? ????? 1)
        ?? ReadyAlbum: "Party"
        ?? ReadyAlbum: "Family"

Hall 2
    ?? EventType: "Wedding" (?????? ????? 2, ???? ????? 1!)
        ?? ReadyAlbum: "Ceremony"
        ?? ReadyAlbum: "Dinner"
```

## ??? ??????? ???? ???????

### ???? `event_types` - ??????:
```sql
CREATE TABLE event_types (
    event_type_id SERIAL PRIMARY KEY,
    event_type_name_key TEXT NOT NULL,
    default_album_s_count INTEGER NOT NULL,
    hall_id INTEGER NULL,  -- ? ???! ??? ?????
    FOREIGN KEY (hall_id) REFERENCES halls(hall_id) ON DELETE CASCADE
);
```

### ???? `hall_event_types` - ?????! ?
????? ??? ??? ?? ????? ?? ??? ???? ???? Many-to-Many.

## ?? ??????? ????

### 1. Model: EventType
```csharp
public class EventType
{
    public int EventTypeId { get; set; }
    public string EventTypeNameKey { get; set; } = null!;
    public int DefaultAlbumSCount { get; set; }
    
    // ? ???: ??? ?????
    public int? HallId { get; set; }
    public Hall? Hall { get; set; }
    
    public ICollection<ReadyAlbum> ReadyAlbums { get; set; } = new List<ReadyAlbum>();
}
```

### 2. Model: Hall
```csharp
public class Hall
{
    public int HallId { get; set; }
    public string Name { get; set; } = null!;
    // ...
    
    // ? ????: ????? ?? One-to-Many
    public ICollection<EventType> AllowedEventTypes { get; set; } = new List<EventType>();
}
```

### 3. HallService: CreateHallAsync
```csharp
public async Task<int> CreateHallAsync(CreateHallDto dto)
{
    // ... ??? ???? ...
    
    var hall = new Hall
    {
        Name = dto.Name,
        // ...
        AllowedEventTypes = new List<EventType>()
    };

    // ? ????? EventType ??? ??? ?? ?????? ????????
    if (dto.AllowedEventTypeIds != null && dto.AllowedEventTypeIds.Any())
    {
        foreach (var eventTypeName in dto.AllowedEventTypeIds)
        {
            if (string.IsNullOrWhiteSpace(eventTypeName))
                continue;

            // ????? EventType ??? ???? ????? ???
            var newEventType = new EventType
            {
                EventTypeNameKey = eventTypeName.Trim(),
                DefaultAlbumSCount = GetDefaultAlbumCount(eventTypeName),
                Hall = hall
            };

            hall.AllowedEventTypes.Add(newEventType);
        }
    }

    _context.Halls.Add(hall);
    await _context.SaveChangesAsync();
    
    return hall.HallId;
}

// Helper method
private int GetDefaultAlbumCount(string eventTypeName)
{
    return eventTypeName.ToLower() switch
    {
        "wedding" or "?????" => 5,
        "barmitzvah" or "?? ?????" or "?? ?????" => 4,
        "brit" or "????" => 3,
        _ => 3 // default
    };
}
```

## ?? ????? ???????? (React)

### ?????:
```javascript
const formData = new FormData();

// ???? ???????
formData.append('Name', '???? ???????');
formData.append('OwnerName', '??? ???');
formData.append('Phone', '054-1234567');
formData.append('Email', 'moshe@example.com');
formData.append('Password', 'Password123!');

// ? ???? ??????? - ???? ????!
const eventTypes = ['Wedding', 'BarMitzvah', 'Brit'];
eventTypes.forEach((name, index) => {
  formData.append(`AllowedEventTypeIds[${index}]`, name);
});

const response = await fetch('https://localhost:7168/api/app/halls', {
  method: 'POST',
  body: formData
});
```

### ?? ???? ????:
1. ???? ????: `["Wedding", "BarMitzvah", "Brit"]`
2. ??? ??, ???? `EventType` **???**:
   ```csharp
   new EventType { EventTypeNameKey = "Wedding", HallId = 1 }
   new EventType { EventTypeNameKey = "BarMitzvah", HallId = 1 }
   new EventType { EventTypeNameKey = "Brit", HallId = 1 }
   ```
3. ?? `EventType` ???? **??** ????? ??? (HallId = 1)

## ? ???????

1. **??????**: ?? ???? ???? ?????? ??????? ????? ????? ??? ?????
2. **??????**: ???? ???? ????? ?????? EventType ???? ?????? ?? ?????? ?????
3. **?????**: ?? ???? ???? junction ??????
4. **????? ???**: ???????? ????, ?? ?-EventTypes ??? ?????? ???????? (CASCADE)

## ?? ???? ????

- **EventTypes ????????**: ?? ?? ?? EventTypes ??????? ????? ???????? (templates), `HallId` ???? `NULL`
- **ReadyAlbums**: ????? ?? EventType ???? ???? ReadyAlbums ???
- **?????**: ???????? ????, ?? ?-EventTypes ??? ??????!

## ?? ????? ????

```csharp
// ???? 1 ???? EventType "Wedding" ?? ?????? ????
Hall hall1 = new Hall { Name = "???? A" };
var wedding1 = new EventType 
{ 
    EventTypeNameKey = "Wedding", 
    DefaultAlbumSCount = 5,
    Hall = hall1 
};

// ???? 2 ???? EventType "Wedding" ?? ?????? ?????!
Hall hall2 = new Hall { Name = "???? B" };
var wedding2 = new EventType 
{ 
    EventTypeNameKey = "Wedding",  // ???? ??
    DefaultAlbumSCount = 7,        // ??? ?????? ?????!
    Hall = hall2 
};

// wedding1 ? wedding2 - ?? ?????? ??????!
```

## ?? Migrations

```bash
# ????? Migration
dotnet ef migrations add EventTypePerHall

# ???? Migration
dotnet ef database update
```

???????? ???? ???????:
1. ? ????? ????? `hall_id` ?-`event_types`
2. ? ????? Foreign Key constraint
3. ? ????? ???? `hall_event_types`
